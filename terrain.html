<html>
    <head>
        <title>just breathe</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, minimal-ui">
        <link href="/stylesheets/app.css" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <script src="/js/lib/jquery.min.js"></script>
        <script src="/js/lib/underscore.min.js"></script>
        <script src="/js/lib/three.min.js"></script>
        <script src="/js/lib/three.Detector.js"></script>
        <!--script src="/js/lib/three.OrbitControls.js"></script-->
        <script src="/js/lib/stats.min.js"></script>
        <script>
            function log() {
                if (window.console && window.console.log) window.console.log.apply(window.console, arguments);
            }

            if (! Detector.webgl) {
                Detector.addGetWebGLMessage({message: 'looks cooler on desktop chrome' });
            }

            var Workspace = function(){
                this.SCREEN_WIDTH = 600;
                this.SCREEN_HEIGHT = 400;

                this.renderer = false;
                this.camera = false;
                this.scene = false;
                this.controls = false;

                this.stats = false;

                this.lights = {
                    directional: [],
                };

                this.init_renderer();
                this.init_camera();
                this.init_scene();
                this.init_lights();

                // this.render_debug_helpers();

                this.update_camera();
                this.render();
            };

            Workspace.prototype.init_camera = function(){
                this.camera = new THREE.PerspectiveCamera(45, this.SCREEN_WIDTH / this.SCREEN_HEIGHT, 0.1, 10000);
                this.camera.position.set(-500, 250, -500);
            };

            Workspace.prototype.init_renderer = function(){
                this.renderer = Detector.webgl ? new THREE.WebGLRenderer() : new THREE.CanvasRenderer();
                this.renderer.setSize(this.SCREEN_WIDTH, this.SCREEN_HEIGHT);
                $("body").append(this.renderer.domElement);
            };

            Workspace.prototype.init_scene = function(){
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x000000, 0.000275);

                // this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
            };

            Workspace.prototype.init_lights = function(){
                this.scene.add(new THREE.AmbientLight(0xffffff));

                var directional = new THREE.DirectionalLight(0xFF8D67, 0.75);
                directional.position.set(-200, 400, -200);
                this.scene.add(directional);
                this.lights.directional.push(directional);
            };

            Workspace.prototype.init_stats = function(){
                this.stats = new Stats();
                this.stats.domElement.style.position = 'absolute';
                this.stats.domElement.style.bottom = '0px';
                this.stats.domElement.style.left = '0px';
                $("body").append(this.stats.domElement);
            };

            Workspace.prototype.update_camera = function(){
                this.SCREEN_WIDTH = window.innerWidth;
                this.SCREEN_HEIGHT = window.innerHeight;

                this.camera.aspect = this.SCREEN_WIDTH / this.SCREEN_HEIGHT;
                this.camera.updateProjectionMatrix();

                this.renderer.setSize(this.SCREEN_WIDTH, this.SCREEN_HEIGHT);
            };

            Workspace.prototype.render_debug_helpers = function(){
                this.init_stats();

                this.scene.add(new THREE.AxisHelper(10000));
                this.scene.add(new THREE.GridHelper(10000, 100));

                _.each(this.lights.directional, function(light){
                    this.scene.add(new THREE.DirectionalLightHelper(light, 100));
                }, this);
            };

            Workspace.prototype.spin_camera = function(){
                this._spin_camera_theta = this._spin_camera_theta || 0;

                this.camera.position.x = -1500 * Math.sin(this._spin_camera_theta * Math.PI / 360);
                this.camera.position.z = -1500 * Math.cos(this._spin_camera_theta * Math.PI / 360);
                this.camera.position.y = 700;
                this.camera.lookAt(this.scene.position);
                this._spin_camera_theta += 0.25;
            };

            Workspace.prototype.render = function(){
                requestAnimationFrame(function(){
                    this.render();
                    if (this.stats) this.stats.update();
                }.bind(this));

                this.spin_camera();

                this.renderer.render(this.scene, this.camera);
                if (this.controls) this.controls.update();
            };

            // ==================================================

            var workspace = new Workspace();

            $(window).resize(function(){
                workspace.update_camera();
            });

            var material = new THREE.MeshLambertMaterial({
                // side: THREE.DoubleSide,
                shading: THREE.FlatShading,
                color: 0x3b2f4a,
                // wireframe: true,
            });

            if (! Detector.webgl) {
                material.overdraw = true;
            }

            var ka = 0.4;
            material.ambient.setRGB( material.color.r * ka, material.color.g * ka, material.color.b * ka );

            var terrain = new THREE.Geometry();
            terrain.dynamic = true;

            var grid_size = 100;

            var columns = 100;
            var rows = -1;

            function add_row(){
                rows += 1;
                var offset = rows * grid_size;

                _.times(columns, function(i){
                    terrain.vertices.push(new THREE.Vector3(i * grid_size, _.random(0, 75), offset));
                });

                if (rows === 0) return;

                _.times(columns, function(i){
                    if ((i + 1) % columns === 0) return;

                    var v1 = (rows - 1) * columns + i;
                    var v2 = rows * columns + i;
                    var v3 = (rows - 1) * columns + i + 1;

                    var face = new THREE.Face3(v1, v2, v3);
                    terrain.faces.push(face);

                    v1 = v2;
                    v2 = rows * columns + i + 1;

                    face = new THREE.Face3(v1, v2, v3);
                    terrain.faces.push(face);
                });

                terrain.verticesNeedUpdate = true;
                terrain.elementsNeedUpdate = true;

                terrain.computeFaceNormals();
                // terrain.mergeVertices();
            }

            add_row();

            _.times(100, function(){
                add_row();
            });

            var ground = new THREE.Mesh(terrain, material);
            ground.position.set(-1 * columns / 2 * grid_size, 10, -1 * rows / 2 * grid_size);

            workspace.scene.add(ground);
        </script>
    </body>
</html>